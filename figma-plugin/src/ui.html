<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: Inter, sans-serif;
      padding: 20px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background: #000;
      color: #fff;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }

    button:disabled {
      background: #ccc;
    }

    .error {
      color: red;
      margin-top: 10px;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <h3>Website to Figma</h3>
  <label>Scraper API URL</label>
  <input id="apiUrl" type="text" value="http://localhost:3000/api/website-to-figma" />

  <label>Target Website URL</label>
  <input id="targetUrl" type="text" placeholder="https://example.com" />

  <div style="text-align: center; margin: 10px 0; color: #666;">- OR -</div>

  <label>Paste JSON from Extension</label>
  <textarea id="jsonInput" placeholder='{"url": "...", "data": {...}}'
    style="width: 100%; height: 60px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; font-family: monospace; font-size: 11px;"></textarea>

  <button id="importBtn">Import to Figma</button>
  <div id="status"></div>

  <script>
    const importBtn = document.getElementById('importBtn');
    const statusDiv = document.getElementById('status');
    const apiUrlInput = document.getElementById('apiUrl');
    const targetUrlInput = document.getElementById('targetUrl');
    const jsonInput = document.getElementById('jsonInput');

    importBtn.onclick = async () => {
      const jsonText = jsonInput.value.trim();

      // MODE 1: JSON Import (Extension)
      if (jsonText) {
        importBtn.disabled = true;
        statusDiv.textContent = 'Parsing JSON...';
        statusDiv.className = '';

        try {
          const parsed = JSON.parse(jsonText);
          // Extension outputs: { url: "...", data: {...} }
          // API outputs: { message: "...", data: {...} }
          // We need to extract 'data'.
          const dataToBuild = parsed.data || parsed;

          if (!dataToBuild) throw new Error("Invalid JSON: Missing 'data' field");

          statusDiv.textContent = 'Building from JSON...';
          parent.postMessage({ pluginMessage: { type: 'build', data: dataToBuild } }, '*');
        } catch (err) {
          statusDiv.textContent = 'JSON Error: ' + err.message;
          statusDiv.className = 'error';
          importBtn.disabled = false;
        }
        return;
      }

      // MODE 2: URL Import (Scraper API)
      const apiUrl = apiUrlInput.value.replace(/\/$/, ''); // simple trim slash
      const targetUrl = targetUrlInput.value;

      if (!targetUrl) {
        statusDiv.textContent = 'Please enter a URL or paste JSON';
        return;
      }

      importBtn.disabled = true;
      statusDiv.textContent = 'Scraping... (this may take a few seconds)';
      statusDiv.className = '';

      try {
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: targetUrl })
        });

        if (!response.ok) {
          throw new Error('Scraper failed: ' + response.statusText + ' (' + response.status + ')');
        }

        const json = await response.json();

        statusDiv.textContent = 'Building in Figma...';
        parent.postMessage({ pluginMessage: { type: 'build', data: json.data } }, '*');

      } catch (err) {
        statusDiv.textContent = 'Connection Error: ' + err.message + '. Is the server running?';
        statusDiv.className = 'error';
        importBtn.disabled = false;
      }
    };

    // Health Check on Load
    (async () => {
      const statusDot = document.createElement('span');
      statusDot.style.cssText = 'display:inline-block; width:8px; height:8px; border-radius:50%; background:#ccc; margin-right:5px;';
      const h3 = document.querySelector('h3');
      h3.prepend(statusDot);

      const apiUrl = apiUrlInput.value.replace(/\/$/, '');
      // Try a simple HEAD or GET to the base URL or API to check availability
      // Since /api/website-to-figma is POST only, we might just try to fetch it and expect 405 Method Not Allowed (which means server IS there)
      // or a dedicated health endpoint. For now, let's assume if we get a response (even 405), it's alive.
      try {
        const res = await fetch(apiUrl, { method: 'POST', body: '{}', headers: { 'Content-Type': 'application/json' } });
        // If we get here, valid DNS/IP. 
        // If status is 500 or 404, it might be an issue, but 400 (missing body properties) means it's running.
        if (res.status !== 503) {
          statusDot.style.background = '#0f0'; // Green
          statusDot.title = "Server Connected";
        } else {
          statusDot.style.background = '#f00'; // Red
          statusDot.title = "Server Unavailable (503)";
        }
      } catch (e) {
        statusDot.style.background = '#f00'; // Red
        statusDot.title = "Server Unreachable";
      }
    })();

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (msg && msg.type === 'done') {
        statusDiv.textContent = 'Done!';
        importBtn.disabled = false;
      }
    };
  </script>
</body>

</html>